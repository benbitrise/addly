name: build-ios-app
on:
  push:
    branches:
      - 'bb/fastlane'
jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.MATCH_DEPLOY_KEY }}
      - uses: actions/checkout@v2
      - run: bundle install
      - run: bundle exec fastlane ios beta
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          DEVELOPER_DIR: /Applications/Xcode_15.3.app/Contents/Developer
      - uses: actions/upload-artifact@v4
        with:
          name: Addly.ipa
          path: Addly.ipa
      - name: Set Artifact ID
        run: echo "ARTIFACT_ID=${{ steps.upload_artifact.outputs.artifact-id }}" >> $GITHUB_ENV
        id: set_artifact_id
      - run:  echo 'Artifact ID is ${{ steps.artifact-upload-step.outputs.artifact-id }}'
      - name: Trigger Bitrise Build
        run: |
          curl -X POST "https://api.bitrise.io/v0.1/apps/${{ secrets.BITRISE_APP_SLUG }}/builds" \
          -H "Authorization: ${{ secrets.BITRISE_ACCESS_TOKEN }}" \
          -H "Content-Type: application/json" \
          -d '{
                "hook_info": {
                    "type": "bitrise"
                },
                "build_params": {
                    "environments": [
                        {
                            "mapped_to": "ARTIFACT_ID",
                            "value": "${{ steps.artifact-upload-step.outputs.artifact-id }}",
                            "is_expand": true
                        }
                    ]
                }
              }'